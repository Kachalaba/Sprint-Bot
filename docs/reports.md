# Експорт та аналітика Sprint-Bot

> Актуально для команд `/export_csv`, `/export_xlsx`, `/export_graphs`.

## Фільтри команди

Будь-яка команда приймає параметри `key=value` через пробіл:

| Ключ        | Приклад             | Опис                               |
|-------------|---------------------|-------------------------------------|
| `athlete`   | `athlete=123456789` | ID спортсмена, `me` → поточний користувач |
| `stroke`    | `stroke=freestyle`  | Стиль (`freestyle`, `backstroke`, `butterfly`, `breaststroke`, `medley`) |
| `distance`  | `distance=100`      | Дистанція у метрах                  |
| `from`      | `from=2024-05-01`   | Початок інтервалу (ISO, UTC)        |
| `to`        | `to=2024-05-31`     | Кінець інтервалу (ISO, UTC)         |

Якщо параметр не вказано, використовується значення за замовчуванням:

- спортсмен — автор команди;
- стиль/дистанція — без обмежень;
- діапазон дат — усі результати.

## CSV

```
/export_csv athlete=123456 stroke=freestyle distance=100 from=2024-05-01 to=2024-05-31
```

Результат: файл `export_123456_freestyle_100.csv` із колонками:

- `timestamp` — ISO datetime (UTC);
- `athlete_id`, `athlete_name`;
- `stroke`, `distance`;
- `total_seconds`, `total_formatted`;
- `is_pr` — 1/0;
- `segments_json` — масив сплітів у секундах.

## XLSX

```
/export_xlsx athlete=me distance=50 from=2024-01-01
```

Результат: файл `export_<me>_any_50.xlsx` (назва підставляє ваш ID). Стовпці як у CSV.

## Графіки

```
/export_graphs athlete=123456 distance=100 stroke=freestyle from=2024-04-01 to=2024-05-31
```

Бот поверне два PNG-файли:

1. **Середня швидкість по сегментах** — усереднені м/с за вибраний період.
2. **Прогрес загального часу** — крива із загальними секундами на кожний заплив.

> Для графіків обовʼязково використовуйте одну дистанцію та стиль.

## Кешування

- Файли та графіки кешуються у `data/cache/reports/` (TTL — 30 хвилин).
- Повторний виклик із однаковими параметрами повертає збережений артефакт.
- Видаляється автоматично після закінчення TTL.

## Типові помилки

| Повідомлення                              | Причина                         |
|-------------------------------------------|---------------------------------|
| `невідома опція`                          | опечатка в ключі (`stroke`, `distance`, `from`, `to`, `athlete`) |
| `початкова дата повинна бути раніше`      | `from` > `to`                   |
| `для графіків вкажіть одну дистанцію/стиль` | фільтр повернув змішані результати |
| `за вибраними фільтрами результати відсутні` | немає підходящих записів        |

## Налаштування

- TTL кешу та шлях задаються у `reports/cache.py` (`CacheSettings`).
- SQLite використовується за замовчуванням (`data/results.db`).
- Графіки рендеряться через `matplotlib` (`Agg`).

## Приклади для тестування

```
pytest -k export
/export_csv athlete=me distance=50
/export_graphs athlete=me distance=100 stroke=freestyle
```
