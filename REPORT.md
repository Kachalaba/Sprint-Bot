# Step Report — Technical Audit

## Что сделано
- Построена карта репозитория и задокументирована в `REPORT_AUDIT.md` (ключевые директории и сервисы).【F:REPORT_AUDIT.md†L3-L34】
- Собран снимок зависимостей (`requirements.txt`, `pip freeze`), зафиксирован стек инструментов CI/CD.【F:REPORT_AUDIT.md†L36-L68】
- Проведён ручной аудит кода: выявлены узкие места Google Sheets, блокирующие вызовы и артефакты конфликтов.【F:REPORT_AUDIT.md†L70-L126】
- Сформирована матрица рисков/рекомендаций, подготовлен roadmap на ближайшие спринты.【F:REPORT_AUDIT.md†L128-L168】

## План / почему так
1. **Инвентаризация** — без карты и зависимостей невозможно приоритизировать технический долг.
2. **Фокус на I/O и интеграциях** — бот упирается в Google Sheets, поэтому анализировали все обращения к ним (handlers/services).
3. **Документация** — оформили результаты в `REPORT_AUDIT.md`, чтобы команда могла ссылаться на выводы.

## Риски
- Высокий риск деградации бота из-за блокирующих вызовов Google Sheets в хэндлерах.【F:handlers/progress.py†L398-L414】【F:handlers/sprint_actions.py†L111-L128】
- Существующие конфликты/артефакты (`handlers/sprint_actions.py.save`) могут случайно попасть в продуктив и сломать импорт модулей.【F:handlers/sprint_actions.py.save†L1-L38】
- Недостаточная типизация и отсутствие pre-commit повышают вероятность регрессий при будущих изменениях.【F:mypy.ini†L1-L8】【F:pyproject.toml†L1-L8】

## Что дальше
- Приоритезировать вынос горячих путей на SQLite и внедрение async-обёрток для Google Sheets (Quick wins в `REPORT_AUDIT.md`).【F:REPORT_AUDIT.md†L142-L158】
- Навести порядок в репозитории: удалить `.save` файлы, добавить проверки на артефакты, усилить линтинг.【F:REPORT_AUDIT.md†L90-L126】
- Запланировать выполнение roadmap (2–4 спринта) с акцентом на миграцию данных и хардненинг инфраструктуры.【F:REPORT_AUDIT.md†L160-L168】

---

# Step Report — Architecture Skeleton

## Карта репозитория
- `bot.py` / `handlers/` — точка входа aiogram и набор хэндлеров команд, включая онбординг, отчёты, экспорт.
- `services/` — процедурные сервисы, обращающиеся к Google Sheets и аналитике команд.
- `utils/`, `filters/`, `middlewares/` — вспомогательные утилиты, кастомные фильтры и промежуточные слои aiogram.
- `db/` — миграции и вспомогательные скрипты работы с БД.
- `reports/`, `notifications.py`, `template_service.py` — генерация отчётов и уведомлений.
- `tests/` — минимальный набор тестов для существующего функционала.
- `sprint_bot/` — новый модуль с каркасом Domain/Application/Infrastructure.

## План работ
1. Зафиксировать архитектурные требования и карту репозитория (данный отчёт).
2. Спроектировать DTO и интерфейсы портов для доменного слоя.
3. Сформировать `ARCH_PLAN.md` с поэтапной миграцией и рисками.
4. Обновить документацию (`CHANGELOG.md`, `REPORT.md`) и подготовить основу для последующих PR.

## Что сделано
- Добавлен пакет `sprint_bot` с сущностями домена и портами приложения для атлетов, тренеров, гонок и телеметрии.
- Описаны сервисные порты для Telegram, Sheets/Postgres, S3 и Sentry, заложены инфраструктурные пространства имён.
- Подготовлен документ `ARCH_PLAN.md` с целевой архитектурой и планом миграции без даунтайма.

## Риски
- Требуется аккуратная реализация адаптеров к Google Sheets, иначе возможна деградация при двойной записи.
- Новые интерфейсы пока не покрыты тестами, что откладывает контроль совместимости.

## Что дальше
- Реализовать адаптеры `WorksheetService` и `AthleteRepository` поверх существующих сервисов.
- Спроектировать первые use-cases (например, импорт результатов гонок).
- Подготовить интеграцию с Sentry и объектным хранилищем в новых пакетах.
